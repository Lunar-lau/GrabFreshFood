<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>GrabFreshFood | Product</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">

    <style>
        /*to remove the spinner arrow from the input box*/
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }


        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .product-container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }


        .product-details {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
        }
    </style>
</head>


<body>
<!-- Top Notice Banner Fragment -->
<div th:replace="~{fragments/topbanner :: topbanner}"></div>

<!-- Navbar Fragment -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5">
    <div class="product-container">
        <div class="row">
            <!-- Left side - Product Image -->
            <div class="col-md-6 mb-4">
                <div class="d-flex justify-content-center align-items-center" style="height: 100%">
                    <!-- If your product is passed to the template, use th:src -->
                    <img class="img-fluid d-block mx-auto" style="width: 50%; height: auto" th:alt="${product.name}"
                         th:src="${product.imageURL}"/>
                </div>
            </div>

            <!-- Right side - Product Details -->
            <div class="col-md-6">
                <div class="product-details">
                    <div class="product-name mb-4">
                        <h3 th:text="${product.name}" class="mb-1">Product Name</h3>
                    </div>
                    <!-- Star Rating -->
                    <div class="d-flex align-items-center mb-3">
                        <span th:each="i : ${#numbers.sequence(1, 5)}"
                              th:classappend="${i <= averageRating} ? 'text-warning' : 'text-muted'">
                            <i class="bi bi-star-fill"></i>
                        </span>
                        <span class="ms-2 text-muted" th:text="'(' + ${#numbers.formatDecimal(averageRating, 1, 1)} + ')'">0.0</span>
                    </div>                    <div class="product-price mb-5">
                        <h3 th:text="'$' + ${#numbers.formatDecimal(product.price, 1, 2)}">Product Price</h3>
                    </div>
                    <div class="mb-5">

                        <p th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></p>
                        <form th:if="${product.quantity > 0}" th:action="@{/product/addToCart}" method="post" onsubmit="return maxQuantity();">
                            <input type="hidden" name="productId" th:value="${product.id}" />

                            <div class="mb-3">
                                <label class="form-label" for="quantity">Quantity</label>

                                <!-- Quantity input group -->
                                <div class="input-group" style="max-width: 140px;">
                                    <button class="btn btn-outline-secondary" onclick="decreaseQuantity()"
                                            type="button">âˆ’
                                    </button>
                                    <input id="quantity" name="quantity" type="number" value="1" min="1" th:attr="max=${product.quantity > 30 ? 30:product.quantity}" required style="width: 50px; text-align: center;">
                                    <button id="addButton" class="btn btn-outline-secondary" onclick="increaseQuantity()"
                                            type="button">+
                                    </button>
                                </div>
                            </div>

                            <!-- add-to-cart button using bootstrap -->
                            <p id="stockStatus" class="text-success">In Stock</p>
                            <button id="addToCart" class="btn btn-grabfreshfood" type="submit">Add to Cart</button>
                            </form>
                        <button th:unless="${product.quantity > 0}" class="btn btn-secondary" disabled>Out of Stock</button>
                    </div>


                    <div class="product-description mb-5">
                        <h4>Description</h4>
                        <p th:text="${product.description}">

                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-5">
            <h4>Customer Reviews</h4>

            <div th:each="review : ${reviews}" class="p-2 mb-2 border rounded">
                <div>
                <span th:each="i : ${#numbers.sequence(1, 5)}"
                      th:classappend="${i <= review.rating} ? 'text-warning' : 'text-muted'">
                    <i class="bi bi-star-fill"></i>
                </span>
                </div>
                <p class="mt-2 mb-0" th:text="${review.comment}">Review comment</p>
            </div>

            <p th:if="${#lists.isEmpty(reviews)}" class="text-muted fst-italic mt-3">
                No reviews yet. Be the first to leave one!
            </p>

            <div class="mt-4">
                <div th:if="${session.customer != null and !alreadyReviewed}">
                    <h5 class="mb-3">Write a Review</h5>
                    <form th:action="@{/product/{id}/review(id=${product.id})}" method="post" th:object="${reviewForm}">
                        <input type="hidden" th:field="*{productId}" th:value="${product.id}" />
                        <div class="mb-2">
                            <label class="form-label">Rating</label>
                            <select class="form-select" th:field="*{rating}" required>
                                <option value="" disabled selected>Select rating</option>
                                <option th:each="i : ${#numbers.sequence(1,5)}" th:value="${i}" th:text="${i}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comment</label>
                            <textarea class="form-control" th:field="*{comment}" rows="3" required placeholder="Share your thoughts..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-outline-primary btn-sm">Submit</button>
                    </form>
                </div>

                <div th:if="${alreadyReviewed}" class="text-info mt-3">
                    You've already submitted a review.
                </div>

                <div th:if="${session.customer == null}" class="mt-3">
                    <a th:href="@{/login}">Log in</a> to write a review.
                </div>
            </div>
        </div>

    </div>
</div>




<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<div th:replace="~{fragments/scripts :: dropdown-hover-script}"></div>

<script>
    const quantityInput = document.getElementById("quantity");
    const stockStatus = document.getElementById("stockStatus");
    const addToCart = document.getElementById("addToCart");
    const addButton = document.getElementById("addButton");


    const maxInput = parseInt(quantityInput.getAttribute("max"))
    const maxStock = Math.min(maxInput, 30);

    //Update the stock message
    function updateStockStatus() {
        const value = parseInt(quantityInput.value) || 0;

        if (value >= maxStock) {
            stockStatus.textContent = "Exceeded stock quantity";
            stockStatus.classList.remove("text-success");
            stockStatus.classList.add("text-danger");
            addToCart.disabled = true;
            addButton.disabled = true;
        } else {
            stockStatus.textContent = "In Stock";
            stockStatus.classList.remove("text-danger");
            stockStatus.classList.add("text-success");
            addToCart.disabled = false;
            addButton.disabled = false;
        }
    }

    // real-time feedback when user type in the input box
    quantityInput.addEventListener("input", updateStockStatus);

    // Update +/- button logic and status update message
    function increaseQuantity() {
        let value = parseInt(quantityInput.value) || 1;
        const max = parseInt(quantityInput.getAttribute("max"));
        if (value < maxStock) {
            quantityInput.value = value + 1;
        }
        updateStockStatus();
    }

    function decreaseQuantity() {
        let value = parseInt(quantityInput.value) || 1;
        if (value > 1) {
            quantityInput.value = value - 1;
        }
        updateStockStatus();
    }

    // Still enforce the max on form submit
    function maxQuantity() {
        const value = parseInt(quantityInput.value) || 1;
        if (value > maxStock) {
            alert("Exceeded maximum quantity");
            return false;
        }
        return true;
    }

    updateStockStatus();
</script>
</body>

</html>